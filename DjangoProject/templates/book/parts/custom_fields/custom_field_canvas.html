{% extends "book/parts/custom_fields/custom_field_frame.html" %}
{% block field_display %}
<img src="{{ custom_field_db_object.canvas.url }}" alt="Drawing"/>
{% endblock %}
{% block field_editor %}
<input type="hidden" id="custom_field_type" name="custom_field_type" value="canvas"/>
<input type="hidden" id="canvas_data" name="canvas_data" value=""/>
<!-- Clickable preview replaces the button -->
<img id="canvasPreview" alt="Canvas preview (Click to draw!)" style="border:1px solid #ccc; flex: 1 1 auto; max-height: 100%; box-sizing: border-box; cursor: pointer" />
<!-- Overlay + popup -->
<div id="overlay">
    <div class="popup">
        <h2>Draw something :)</h2>
        <div class="toolbar">
            <label>Color: <input type="color" id="colorPicker" value="#000000" /></label>
            <label>Brush Size: <input type="range" id="brushSize" min="1" max="50" value="5" /></label>
            <button id="eraserBtn">Eraser</button>
            <button id="clearBtn">Clear</button>
        </div>
        <canvas id="canvas"></canvas>
        <div id="brushPreview"></div>
        <button id="closePopup">Close</button>
    </div>
</div>

<style>
canvas {
  border: 1px solid #ccc;
  cursor: none;
  height: 100%;
  width: 100%;
}
.toolbar {
  display: flex;
  flex-direction: row;
  padding: 5px;
  gap: 3px;
}
#brushPreview {
  position: absolute;
  pointer-events: none;
  border: 2px solid black;
  border-radius: 50%;
  background: rgba(0,0,0,0.1);
  transform: translate(-50%, -50%);
}
#overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}
.popup {
  background: #fff;
  display: flex;
  flex-direction: column;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  max-width: 90%;
  box-shadow: 0 0 15px rgba(0,0,0,0.3);
  box-sizing: border-box;
}
</style>

<script>
  document.body.appendChild(document.getElementById('overlay'));
  const overlay = document.getElementById('overlay');
  const closePopup = document.getElementById('closePopup');
  const canvasPreview = document.getElementById('canvasPreview');

  // Open popup when clicking the preview
  canvasPreview.onclick = () => {
      overlay.style.display = 'flex';
      resizeCanvasToDisplaySize();
      loadSavedDrawing();
  };

  // Close popup and update preview
  closePopup.onclick = () => {
      saveCanvasDrawing();
      updatePreview();
      overlay.style.display = 'none';
  };

  // Draw preview from saved data
  function updatePreview() {
      const dataField = document.getElementById('canvas_data');
      const savedData = dataField.value;
      if (savedData) {
          canvasPreview.src = savedData;
      }
  }
  // Initialize preview on page load
  updatePreview();
</script>

<script>
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  function resizeCanvasToDisplaySize() {
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const displayWidth  = Math.round(rect.width * dpr);
      const displayHeight = Math.round(rect.height * dpr);
      if (canvas.width !== displayWidth || canvas.height !== displayHeight) {
          canvas.width = displayWidth;
          canvas.height = displayHeight;
          ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
  }

  // Drawing logic
  let isDrawing = false;
  let currentColor = colorPicker.value;
  let currentSize = brushSize.value;
  let isEraser = false;

  function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
  }

  canvas.addEventListener('mousedown', e => {
      isDrawing = true;
      const {x, y} = getPos(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
  });

  canvas.addEventListener('mouseup', () => { isDrawing = false; ctx.closePath(); });
  canvas.addEventListener('mouseleave', () => { isDrawing = false; });

  canvas.addEventListener('mousemove', e => {
      brushPreview.style.left = e.pageX + 'px';
      brushPreview.style.top = e.pageY + 'px';
      brushPreview.style.width = currentSize + 'px';
      brushPreview.style.height = currentSize + 'px';
      brushPreview.style.borderColor = isEraser ? 'white' : currentColor;
      if (!isDrawing) return;
      const {x, y} = getPos(e);
      ctx.lineTo(x, y);
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.lineWidth = currentSize;
      ctx.strokeStyle = isEraser ? 'white' : currentColor;
      ctx.stroke();
  });

  colorPicker.addEventListener('input', e => {
      currentColor = e.target.value;
      if (!isEraser) brushPreview.style.borderColor = currentColor;
  });
  brushSize.addEventListener('input', e => currentSize = e.target.value);
  eraserBtn.addEventListener('click', () => {
      isEraser = !isEraser;
      eraserBtn.textContent = isEraser ? 'Brush' : 'Eraser';
  });
  clearBtn.addEventListener('click', () => ctx.clearRect(0, 0, canvas.width, canvas.height));
  window.addEventListener('resize', resizeCanvasToDisplaySize);
</script>

<!-- Canvas save & load logic -->
<script>
  function saveCanvasDrawing() {
      const dataField = document.getElementById('canvas_data');
      dataField.value = canvas.toDataURL('image/png');
  }

  function loadSavedDrawing() {
      const dataField = document.getElementById('canvas_data');
      const savedData = dataField.value;
      if (!savedData) return;
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      img.src = savedData;
  }
</script>
{% endblock %}
